name: Update Running Stats

on:
  schedule:
    # Runs daily at 6 AM UTC (adjust as needed)
    - cron: '0 6 * * *'
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write  # Allow the workflow to commit and push

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          pip install requests
          
      - name: Fetch Strava data and update stats
        env:
          STRAVA_CLIENT_ID: ${{ secrets.STRAVA_CLIENT_ID }}
          STRAVA_CLIENT_SECRET: ${{ secrets.STRAVA_CLIENT_SECRET }}
          STRAVA_REFRESH_TOKEN: ${{ secrets.STRAVA_REFRESH_TOKEN }}
        run: |
          python << 'EOF'
          import requests
          import json
          import os
          from datetime import datetime

          # Get new access token using refresh token
          auth_url = "https://www.strava.com/oauth/token"
          auth_data = {
              'client_id': os.environ['STRAVA_CLIENT_ID'],
              'client_secret': os.environ['STRAVA_CLIENT_SECRET'],
              'refresh_token': os.environ['STRAVA_REFRESH_TOKEN'],
              'grant_type': 'refresh_token'
          }
          
          print("Requesting new access token from Strava...")
          auth_response = requests.post(auth_url, data=auth_data)
          
          print(f"Auth response status: {auth_response.status_code}")
          
          if auth_response.status_code != 200:
              print(f"Error response: {auth_response.text}")
              raise Exception(f"Failed to get access token: {auth_response.status_code}")
          
          auth_json = auth_response.json()
          access_token = auth_json['access_token']
          print("Successfully obtained access token")
          
          # Fetch activities for 2026
          headers = {'Authorization': f'Bearer {access_token}'}
          activities_url = "https://www.strava.com/api/v3/athlete/activities"
          
          # Get activities after January 1, 2026
          after_timestamp = int(datetime(2026, 1, 1).timestamp())
          params = {
              'after': after_timestamp,
              'per_page': 200  # Adjust if you expect more than 200 activities
          }
          
          print(f"Fetching activities after {datetime(2026, 1, 1).strftime('%Y-%m-%d')}...")
          
          all_activities = []
          page = 1
          
          while True:
              params['page'] = page
              response = requests.get(activities_url, headers=headers, params=params)
              
              if response.status_code != 200:
                  print(f"Error fetching activities: {response.status_code}")
                  print(f"Response: {response.text}")
                  raise Exception(f"Failed to fetch activities: {response.status_code}")
              
              activities = response.json()
              
              if not activities:
                  break
              
              print(f"Fetched {len(activities)} activities from page {page}")
              all_activities.extend(activities)
              page += 1
              
              # Safety break if more than 1000 activities
              if page > 5:
                  break
          
          print(f"Total activities fetched: {len(all_activities)}")
          
          # Filter for runs and calculate total distance
          total_distance_meters = 0
          run_count = 0
          seen_timestamps = {}  # Track activities by start time to avoid duplicates
          
          print("Processing running activities...")
          
          for activity in all_activities:
              if activity['type'] in ['Run', 'VirtualRun']:
                  # Skip Nike Run Club activities
                  if 'Nike Run Club' in activity['name']:
                      print(f"  Skipping NRC: {activity['name']}")
                      continue
                  
                  # Additional check: avoid duplicates by timestamp
                  start_time = activity['start_date']
                  distance = activity['distance']
                  
                  # Create a key for this run (date + approximate distance)
                  run_key = f"{start_time[:16]}_{int(distance/100)}"  # Round to 100m
                  
                  # Skip if we've already counted a very similar run
                  if run_key in seen_timestamps:
                      print(f"  Skipping duplicate: {activity['name']} ({distance/1000:.2f} km)")
                      continue
                  
                  seen_timestamps[run_key] = True
                  total_distance_meters += distance
                  run_count += 1
                  date = start_time[:10]
                  device = activity.get('device_name', 'Unknown')
                  print(f"  âœ“ {date}: {activity['name']} ({distance/1000:.2f} km) [{device}]")
          
          # Convert to kilometers
          total_km = total_distance_meters / 1000
          
          # Prepare stats object
          stats = {
              'total_km': round(total_km, 2),
              'run_count': run_count,
              'last_updated': datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC'),
              'year': 2026,
              'goal_km': 1000
          }
          
          # Create _data directory if it doesn't exist
          import os
          os.makedirs('_data', exist_ok=True)
          
          # Write to JSON file in _data folder
          with open('_data/running-stats.json', 'w') as f:
              json.dump(stats, f, indent=2)
          
          print(f"Updated stats: {total_km:.2f} km from {run_count} runs")
          EOF
          
      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add _data/running-stats.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update running stats [automated]" && git push)
